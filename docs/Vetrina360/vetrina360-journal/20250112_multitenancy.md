### Introduction
First days of trying to create a good ERP software for retail companies. I think there is a market demand for this kind of software and the one I am working on right now at my current job isn't that good: many design flaws. First of all, why the heck should a company with 6 (six!) developers choose to design it's software as a microservices architecture? The reason is "the old software is monolithic and it sucks: has become a mess over the (many) years."... yes, but the old software was developed is VB6 and without any design best practice in mind. As our beloved DHH said, ["Run a small team, not a tech behemoth? Embrace the monolith and make it majestic. You deserve it!"](https://signalvnoise.com/svn3/the-majestic-monolith/). So here we are: managing a backend made of 20+ microservices has become a mess in a backend team of 3 people (also because of me, I personally made some implementation choices not as wise as I initially though) and I feel the will to prove to myself that, if I had to develop such software from scratch, I would have done it much better. Plus, I do not have many expectations on the future of my current company, so having a SaaS product ready to be shipped to potential customers is kind of a parachute in my mind. Am I wrong? Maybe, but trying costs nothing but time and dedication, and I need a personal project to find the love for programming again. So here we are. I've already embraced some design choices: 
- My SaaS product will be a **Ruby on Rails full-stack application** with server side rendering. I've already worked with Ruby on Rails before, like 5 years, and I feel that, even if I am not totally aware of its full potential, I'm kinda confident with it. Plus, I really like the way it forces developers to act in a specific way, which is believed to be "the best", or ["the Rails way"](https://rubyonrails.org/doctrine). Plus, I'm really eager to learn all the new features introduced with RoR 7 and 8.
- The database will be **PostgreSQL**, a RDBMS that I think works really great. I've been working with MSSQL for the last two years and I think it is pure shit compared to PSQL: `json` and `jsonb` columns are managed way better in Postgres, as well as full text search functionalities, and in general I've had way more troubles working with MSSQL then working with Postgres. Plus, it is open source.
- The **multi-tenancy** implementation will be at **database level**: it's harder to implement and to add tenants along the way, but I think it gives me more flexibility and easily accomplishes many security concerns. Plus, this is the way adopted at my current company, and it seems to work good.

### Multi-tenancy implementation options
Given that I want to implement database-level multi-tenancy, I've searched the web and asked to ChatGPT for advices and potential solutions. I've considered the following options:
- [Apartment](https://github.com/rails-on-services/apartment) gem was used in the product of the first company I worked for, and it worked kinda good. But the gem is no longer actively maintained right now (the linked repository is a fork made to be available in RoR 6 and 7, but it doesn't guarantee long term). So in my opinion it is not the best choice. Plus, I don't have experience in configuring it, so neither previous knowledge is a point in favour of its adoption. *REJECTED.*
- [act_as_tenant](https://github.com/ErwinM/acts_as_tenant) gem, found as recommended in some reddit posts, also does not seem to be well maintained. And it only allows for row-level multi-tenancy. *REJECTED.*
- custom implementation? I found an article that truly convinced me to take this path: [Building a Multi-tenant Ruby on Rails App With Subdomains](https://blog.appsignal.com/2020/12/02/building-a-multi-tenant-ruby-on-rails-app-with-subdomains.html) by [Paweł Dąbrowski](https://www.paweldabrowski.com/). In this blog post written in 2020, he shows how to use RoR multi db support introduced in Rails 7 to implement multi-tenancy. It is just a proof of work, but it gives many space for customisation, so I think I will follow it for a first version of multi-tenancy implementation in my application. **_ADOPTED_**.

### How was it implemented at the end? What to do in order to add a tenant?
At the end, multi-tenancy is basically implemented as described in the article cited within the last bullet point of the previous paragraph. The only thing that differs is the adoption of a middleware, `TenantMiddleware`, to connect to the right database before the request reaches the controller. I find it very straightforward.
In order to create a new tenant, these are the things to do:
1. Define a new database as `primary_<tenant_subdomain>` in the `config/database.yml` configuration file under the right environment
2. Add a new tenant in the `tenants` table. This can be done also using rails console (`rails c`): `Tenant.create(slug: "<tenant_subdomain>", name: "<descriptive name>")`
3. Add the mapping `127.0.0.1    tenant_subdomain.vetrina360.local` to your `/etc/hosts` file
4. Add `<tenant_subdomain>: { writing: :primary_<tenant_subdomain>, reading: :primary_<tenant_subdomain> }` to `app/models/application_record.rn` inside block `connects_to shards`
5. Add the new tenant full host to `config.hosts`
6. Launch db migrations `rails db:migrate`
7. That's it - you are ready to go!